# 1 传输层的基本服务

## 1.1 传输层功能

> 只有主机才有传输层，网络核心中的路由器、交换机、集线器等只用到下三层的功能。

1. 对应用层报文进行分段和重组。
2. 面向应用层实现复用与分解。
3. 实现端到端的流量控制。
4. 拥塞控制。
5. 传输层寻址。
6. 对报文进行差错控制。
7. 实现进程间端到端可靠数据传输控制。

<吩咐刘墉寻差错-可靠>

**传输层的核心任务：**  应用进程之间提供端到端的逻辑通信服务。

**一台计算机中，不同应用进程用进程标识符（进程ID）来区分。**

## 1.2 传输层寻址与端口

**在传输层使用协议端口号，通常简称为端口 PORT 在 全网范围内利用 “IP 地址 + 端口号” 唯一标识一个通信端点。**

**传输层端口号为16位整数，可以编号65536个（2的16次方）**

| 端口范围    | -          | -            |
| ----------- | ---------- | ------------ |
| 0-1023      | 熟知端口号 | 服务器端口号 |
| 1024-49151  | 登记端口号 | 服务器端口号 |
| 49152-65535 | 短暂端口号 | 客户端口号   |

端口号小于 256 的端口为常用端口。

## 1.3 无连接服务与面向连接服务

**无连接服务：**  数据传输之前，无需与对端进行任何信息交换，直接构造传输层报文段并向接收端发送。

**面向连接服务：**

数据传输之前，需要双方交换一些控制信息，建立逻辑连接，然后再传输数据，传输结束后还需要拆除连接。

# 2 传输层的复用与分解

> 支持众多应用进程共用同一个传输层协议，并能够将收到的数据准确交付给不同的应用进程。

**多路复用：**  在源主机，传输层协议从不同的套接字收集应用进程发送的数据块，并为每个数据块封装上首部信息（包括用于分解的信息）构成报文段，然后将报文段传递给网络层。

**多路分解：** 在目的主机，传输层协议读取报文段中的字段，标识出接收套接字，进而通过该套接字，将传输层的报文段中的数据交付给正确的套接字。

**无连接的多路复用与多路分解：**  UDP  <目的IP地址，目的端口号> 

**面向连接的多路复用与多路分解：**  TCP<源IP地址，源端口号，目的IP地址，目的端口号>

# 3 停-等协议与滑动窗口协议

## 3.1 可靠数据传输基本原理

（基于不可靠信道实现可靠数据传输采取的措施）

1. 差错检测: 利用编码实现数据报传输过程中的比特差错检测。
2. 确认：接收方向发送方反馈接收状态。（ACK：肯定数据 NAK：否定确认）
3. 重传：发送方重新发送接收方没有正确接收的数据。
4. 序号：确保数据按需提交。
5. 计时器：解决数据丢失问题。

## 3.2 停-等协议（自动重传请求协议 ARQ）

1. 发送方发送经过差错编码和编号的报文段，等待接收方的确认。
2. 接收方如果差错检测无误且序号正确，则接收报文段，并向发送方发送ACK，否则丢弃报文段，并向发送发发送NAK。
3. 发送方如果收到ACK，则继续发送后续报文段，否则 重发刚刚发送的报文段。

## 3.3 滑动窗口协议

**流水线协议（管道协议）：**  允许发送方在没有收到确认前连续发送多个分组。最典型的流水线协议：滑动窗口协议。

1. 增加分组序号。
2. 发送方和接收方法可以缓存多个分组。

**发送窗口（Ws）：** 发送方可以发送未被确认分组的最大数量。

**接收窗口（Wr）：** 接收方可以缓存的正确到达的分组的最大数量。

**滑动窗口协议，根据窗口的大小，可以具体分为：**

- 回退N步协议：GBN
  - 发送窗口 Ws >= 1 接收窗口 Wr = 1
  - 发送端缓存能力高，可以在没有得到确认前发送多个分组。
  - 接收端缓存能力很低，只能接收1个按序到达的分组，不能缓存未按序到达的分组。
  - GBN发送方响应的3类事件：
    - 上层调用。
    - 收到1个ACKn。GBN采用累积确认方式，即发送方收到ACKn时，表明接收方正确接收序号n以及序号小于n的所有分组。
    - 计时器超时。发送方只使用一个计时器。
- 选择重传协议：SR
  - 发送端缓存能力高。
  - 接收端缓存能力高。
  - SR发送方响应事件：
    - 上层调用
    - 计时器超时。发送方对每个分组进行计时。
    - 收到ACKn。SR协议采取逐个确认方式。

# 4 用户数据报协议（UDP）

## 4.1 UDP 特点

用户数据协议：Internet 传输层协议，提供无连接、不可靠数据报尽力传输服务。

**特点：**

- 应用进程容易控制发送什么数据以及何时发送，会出现分组的丢失和重复。
- 无需建立连接
- 无连接状态
- 首部开销小，只有8字节

## 4.2 UDP 数据报结构

**UDP 首部四个字段：**  每个字段长度都是 2 个字节，共 8 个字节。

- 源端口号和目的端口号：UDP 实现复用和分解。
- 长度：只是UDP报文段中的字节数（首部和数据的总和）。
- 校验和： 接收方使用来检测数据报是否出现差错。

## 4.3 UDP 校验和

UDP 的校验和用于检测 UDP 报文段从源到目的地传送过程中，其中数据是否发生改变。

**UDP 校验和的计算规则：**

1. 所有参与运算的内容按16位对齐求和。
2. 求和过程中遇到溢出（即进位）都被回卷（即进位与和的最低位再相加）。  
3. 最后得到的和取反码，就是UDP的校验和，填入UDP数据报的校验和字段。

UDP 校验和计算的内容包括 3 部分： UDP 伪首部、UDP首部，应用数据。

UDP 伪首部由 源 IP 地址、目的 IP 地址、 协议号  （17）、长度组成

# 5 传输控制协议（TCP）

## 5.1 TCP 报文段结构

传输控制协议(Transmission Control Protocol ,TCP)：Internet传输层协议。提供面向连接、可靠、有序、字节流 传输服务。

**特点：**

1. 应用进程先建立连接
2. 每一条 TCP 连接只有两个端点
3. 可靠交付：无差错，不丢失，不重复，按序到达。
4. 全双工通信。
5. 面向字节流

流： 字节序列。应用程序和 TCP 的交互是一个个数据块，TCP 把他们看作是无结构字节流。

**最大报文长度（MSS）：**   报文段中封装的应用层数据的最大长度。

**TCP 首部：**

- 源端口号：16位  复用和分解上层应用的数据
- 目的端口号：16位  复用和分解上层应用的数据
- 序号：32 位      TCP的序号是对每个应用层数据的每个字节进行编号 。
- 确认序号：32 位      期望从对方接收数据的字节序号，即该序号对应的字节尚未收到，用ack_seq表示  
- 首部长度：4 位      指出TCP段的首部长度，以4字节为计算单位 （多少个4字节）
- 保留：     占6位。保留为今后使用，目前值为0  
- 标志位：6 位
  - URG：紧急指针字段有效，优先发送。
  - ACK：1 确认字段有效 0 确认字段无效
  - PSH：1 尽快将报文段中的数据交付应用进程，不要等缓存满了再交付。
  - RST： 1 TCP 连接出现严重差错，释放连接，再重新建立 TCP 连接。
  - SYN： 1 该TCP 报文段是一个建立新连接请求控制段或者同意建立新连接的确认段。
  - FIN：TCP 报文段的发送端数据已经发送完毕，请求释放连接。
- 接收窗口：16 位。 向对方通告我方接收窗口的大小，实现 TCP 的流量控制。
- 校验和： 16 位 计算方法与 UDP 校验和的计算方法相同
- 紧急指针：16 位 URG = 1 时才有效。指出在本 TCP 报文段中紧急数据共有多少个字节。
- 选项（长度可变）：最短 0 字节 最长 40 字节
- 填充：取值全为0，目的是为了整个首部长度是4字节的整倍数。

20 字节固定首部

## 5.2 TCP 连接管理

**三次握手：**

- 第一次握手：

    客户向服务器发送连接请求段：（SYN=1,seq=x）

  ​     SYN=1：建立连接请求控制段

  ​     seq=x：表示传输的报文段的第1个数据字节的序列号是x，此序列号代表整个报文段的序号。

    客户端进入SYN_SEND（同步发送） 

- 第二次握手：

   服务器发回确认报文段：（SYN=1,ACK=1,seq=y, ack_seq=x+1）

  ​    SYN=1：同意建立新连接的确认段

  ​    ACK=1：确认序号字段有效

  ​    seq=y：服务器告诉客户确认报文段的序列号是y。

  ​    ack_seq=x+1：表示已经收到了序列号为x的报文段，准备接收序列号为x+1的报文段。

  服务器由LISTEN进入SYN_RCVD（同步收到）

- 第三次握手：

    客户对服务器的 同意连接报文段 进行确认：（ACK=1,seq=x+1,ack_seq=y+1）

  ​     ACK=1：确认序号字段有效

  ​     seq=x+1：客户此次的报文段的序列号是x+1。

  ​     ack_seq=y+1：客户期望接收服务器序列号为y+1的报文段。

    当客户发送ACK时，客户端进入ESTABLISHED状态；

    当服务收到ACK后，也进入ESTABLISHED状态；

    第三次握手可携带数据。

**为什么要三次握手：**

- 第一次握手：客户发送请求，此时服务器知道客户能发。
- 第二次握手：服务器发送确认，此时客户知道服务器能发能收。
- 第三次握手：客户发送确认，此时服务器知道客户能收。

**四次挥手：**

- 第一次挥手：

    客户向服务器发送释放连接报文段：（FIN=1,seq=u）

  ​    FIN=1：发送端数据发送完毕，请求释放连接。

  ​    seq=u：传输的第一个数据字节的序号是u

    客户端状态由ESTABLISHED进入FIN_WAIT_1（终止等待1状态）

- 第二次挥手：

    服务器向客户发送确认段：（ACK=1,seq=v,ack_seq=u+1）

     ACK=1：确认字号段有效。

     ack_seq=u+1：服务器期望接收客户数据序号为u+1。

     seq=v：服务器传输的数据序号是v。

    服务器状态由ESTABLISHED进入CLOSE_WAIT（关闭等待）

    客户端收到ACK段后，由FIN_WAIT_1进入FIN_WAIT_2

- 第三次挥手：

    服务器向客户发送释放连接报文段：（FIN=1,ACK=1,seq=v+1,ack_seq=u+1）

     FIN=1：请求释放连接

     ACK=1：确认字号段有效。

     ack_seq=u+1：表示服务器期望接收客户数据序号为u+1。

     seq=v+1：表示自己传输的第一个数据字节的序号是v+1。

    服务器状态由CLOSE_WAIT进入LAST_ACK（最后确认状态）

- 第四次挥手：

    客户向服务器发送确认段：（ACK=1,seq=u+1,ack_seq= v+1+1 ）

     ACK=1：确认字号段有效。

     ack_seq=v+1+1：表示客户期望接收服务器数据序号为v+1+1。

     seq=u+1：表示客户传输的数据的序号是u+1。

    客户端状态由FIN_WAIT_2进入TIME_WAIT，等待2MSL时间，进入CLOSED状态。

    服务器在收到最后一次ACK后，由LAST_ACK进入CLOSED。



## 5.3 TCP 可靠数据传输

**可靠：**  保证接收方应用进程从缓冲区读出字节流与发送方发送得字节流是完全一样得。

**TCP实现可靠数据传输服务的工作机制：**  

1. 应用层数据被分割成TCP 认位最合适发送得数据块。
2. 序号，发送方对发送得数据包进行编号，确保数据按序提交给接收方。
3. 确认，接收方向发送方反馈接收状态，确认是否正确接收数据。
4. 差错检测，利用差错编码实现数据包传输过程中得比特差错检测（甚至纠正）。
5. 重传，发送方重新发送接收方没有正确接收得数据。
6. 计时器，在发送方引入计时器，解决数据丢失得问题。

**TCP ACK 生成策略：**

1. 具有所期望序号得报文段按序到达，所有在期望序号及之前得报文段都已被确认，TCP 延迟 500 ms 发送 ACK
2. 具有所期望序号得报文按序到达、且另一个按序报文段在等待 ACK 传输， TCP 接收方理机发送单个累计 ACK ，确认以上两个按序到达的报文段。
3. 拥有需要大于期望序号的失序报文段到达，TCP 接收方立即发送重复 ACK，指示 下一个期望接入字节的序号。
4. 收到一个报文段，部分或完全填充数据间隔。

**计时器超时时间设置：**

TimeoutInerval=EstimatedRTT+4×DevRTT

EstimatedRTT：抽样RTT的加权移动平均值。

DevRTT：偏差RTT

## 5.4 TCP 流量控制

**流量控制：** 协调发送方与接收方的数据发送与接收速度。

在通信过程中，接收方设置报文段的接收窗口字段来将窗口大小通知给发送方。 

## 5.5 TCP 拥塞控制

**网络拥塞：** 太多主机以太快的速度向网络中发送太多的数据，超出了网络处理能力，导致大量数据分组拥挤在中间设备队列等待转发，网络性能显著下降的现象。

**拥塞控制：** 通过合理的调度、规范、调整向网络中发送数据的主机数量、发送速率、数据量，以避免拥塞或消除已经发生的拥塞。

**拥塞窗口：** 连接开始为 1 MSS

**TCP 拥塞控制算法：**

- 慢启动：在TCP连接建立时，每经过1个RTT时间，拥塞窗口增大一倍。
- 拥塞避免：当拥塞窗口大于等于阈值时，每经过1个RTT，拥塞窗口的值加1。
- 快速重传： 接收端收到3次重复确认，则推断被重复确认的报文段已经丢失，于是立即发送被重复确认的报文段。  
- 快速恢复：阈值为当前拥塞窗口的一半，不再重新从慢启动阶段开始，而是直接从新的阈值开始，直接进入拥塞避免阶段。  

**计时器超时：**

- 新的阈值：为当前拥塞窗口的一半。  

- 新的拥塞窗口：直接调整为1MSS。  

  调整好新的阈值和新的拥塞窗口后，使用慢启动，拥塞避免算法增加拥塞窗口大小。

**窗口调整的基本策略：**

网络未发生拥塞时，逐渐“加性”增大窗口。

网络拥塞时“乘性”减小窗口。

**拥塞预防策略：**   流量整形技术：规范主机向网络发送数据的流量。   

