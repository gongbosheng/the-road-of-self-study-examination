# 一、 脚本目录结构

## 1 工作目录

/data/scripts/oss/zabbix/polling

```
mail.py                     # 邮件
polling.py                  # 主程序
example.html                # 基础 html 文件（带有最基本的样式框架）
polling.html.               # 填充完数据的 html
exclude_host.conf           # 主机过滤列表（支持正则和 # 注释）
exclude_item.conf           # 监控项过滤列表（支持正则和 # 注释）
exclude_trigger.conf        # 触发器过滤列表 （支持正则和 # 注释）
exclude_trigger_error.conf  # 触发器错误过滤列表  （支持正则和 # 注释）
cpu.json                    # zabbix cpu 异常使用情况 详细文件
mem.json                    # zabbix 内存 异常使用情况 详细文件
trapper_items.json          # 异常 trapper item 详细文件
mem.png                     # mem 各使用情况区间饼图
cpu.png                     # cpu 各使用情况区间饼图
ed.png                      # host 启用禁用情况饼图
gbh.png                     # host 正常异常情况饼图
gbi.png                     # other item 异常，trapper item 异常， trigger 异常， discovery 异常 分布情况饼图
```



## 2 监控采集目录

```
/usr/local/zabbix/share/zabbix/alertscripts/polling.py   # 记录trigger 异常， discovery 异常  other item  异常
/usr/local/zabbix/share/zabbix/alertscripts/polling      # 历史记录
 - discovery_20220225.json  # discovery 2022年 2 月 25 日异常记录       
 - item_20220218.json       # item 2022年 2月 18 日异常记录
 - trigger_20220211.json    # trigger 2022年 2 月 11 日异常记录
```



# 二、 脚本逻辑

> 巡检主要分为以下三个阶段
>
> - 数据采集
> - 数据过滤
> - 生成 HTML
> - 发送邮件

## 1 数据采集

主要采集的数据有以下几种

- 主机 监控信息
- 主机 状态信息
- ITEM 状态信息
- zabbix_agent 内存 使用情况
- zabbix_agent CPU 使用情况

### 1.1 主机 监控信息

通过 zabbix api host.get 接口获取主机启用禁用情况，统计启用禁用主机数量。

### 1.2 主机 状态信息

通过 zabbix api host.get 接口获取主机上目前存在的 interface ，并统计主机状态正常和异常的数量。并记录错误主机名和错误信息。

### 1.3 ITEM 状态信息

根据监控项类型，可分为两种数据采集方式。

- zabbix api 采集 trapper 类型的监控项超时（目前为 5 min）未获取到数据的监控项目为异常 

- 通过 Internal action 触发 

  - [Report not supported items](https://zbx.eeo-inc.com/actionconf.php?eventsource=3&form=update&actionid=4)
  - [Report not supported low level discovery rules](https://zbx.eeo-inc.com/actionconf.php?eventsource=3&form=update&actionid=5)
  - [Report unknown triggers](https://zbx.eeo-inc.com/actionconf.php?eventsource=3&form=update&actionid=6)

  通过记录脚本记录并按照日期，类型进行分文件存储。

```json
{
	host: {
		itemname/traggername/discovername :{
			error :[
				time1,
				time2,
			]
		}
	}
}
```



### 1.4 zabbix_agent 内存使用情况

通过添加监控项 proc.mem[zabbix_agentd] 来对 zabbix_agent 内存使用的情况进行监控。并通过 zabbix api trend.get 接口获取主机的趋势信息。并分主机统计该日最大值。对最大值进行以 200M 为一个区间进行分区间存储。

```
{
	200-400M: [
		host1
		host2
		...
	]
}
```



### 1.5 zabbix_agent CPU 使用情况

通过添加监控项 proc.cpu.util[zabbix_agentd] 来对 zabbix_agent CPU使用的情况进行监控。并通过 zabbix api trend.get 接口获取主机的趋势信息。并分主机统计该日最大值。对最大值进行以 2% 为一个区间进行分区间存储。

```
{
	2%-%4: [
		host1
		host2
		...
	]
}
```



## 2 数据过滤

将获取的数据，以如下文件作为配置文件进行，过滤。当匹配到文件中规则时，视为正常。

```
exclude_host.conf           # 主机过滤列表（支持正则和 # 注释）
exclude_item.conf           # 监控项过滤列表（支持正则和 # 注释）
exclude_trigger.conf        # 触发器过滤列表 （支持正则和 # 注释）
exclude_trigger_error.conf  # 触发器错误过滤列表  （支持正则和 # 注释）
```

将统计的数字绘制成饼图展示。

## 3 生成 HTML

基于 example.html  生成 polling.html， 将获取到的数据填充到 html 中。

## 4 发送邮件

将生成polling.html 和 详细文件作为附件发送。

