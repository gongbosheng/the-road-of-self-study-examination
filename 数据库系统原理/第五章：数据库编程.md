# 1 存储过程

## 1.1 存储过程的基本概念

存储过程是一组为了完成某项特定功能的SQL语句集，

其实质就是一段存储在数据库中的代码。

它可以由声明式的 SQL 和过程式 SQL 语句组成。

存储过程是一组为了完成某项特定功能的SQL语句集，其实质就是一段存在数据库中的代码。

- 可增强SQL语言的功能性和灵活性
- 良好的封装性
- 高性能（执行会被编译，第一次执行后编译后的二进制会被放到高速缓冲区）
- 减少网络流量（执行调用语句就行，而不用传语句集）
- 可作为一种安全机制来确保数据库的安全性和数据的完整性

## 1.2 创建存储过程

将 MySQL结束符修改为两个$$

```sql
delimiter $$;
-- $$ 通用
```

使用 create procedure 语句创建存储过程

```sql
create procedure sp_name ([proc_parameter[,...]]) begin routine_body end
```

- create procedure  固定语法
- sp_name 存储过程名
- proc_paramenter 参数
  - in  param type        
    - in 给参数传入值，定义的参数就得到了值
    - param  变量名（有点像函数的形参）
    - type 数据类型（注意，这里设置的数据类型要遵循原表对属性的定义 我尝试了一下 这个数据类型 在输入其他非指定类型的时候并不会起到约束作用，只会报warring）
  - out param type
    - out 模式定义的参数只能在过程体内部复制，表示该参数可以将某个值传递回调用它的过程（在存储过程内部，该参数初始值为null ，无论调用者是否给存储过程参数设置值）
  - inout  param type    
    - inout 调用者还可以通过 inout 参数传递值给存储过程，也可以从存储过程内部传值给调用者。
- begin routine_body end 存储过程体固定写法

## 1.3 存储过程体

```sql
-- 在 mysql_test 中创建一个存储过程，用于实现给定表 cust 中 一个客户id号即可修改表 cust 中该客户的性别为一个指定的性别

-- 第一步
use mysql_test;
-- 第二步
delimiter $$
-- 第三步
mysql> create procedure sp_update_sex(in cid int,in csex char(10))
    -> begin
    ->  update cust set sex=csex where cust_id = cid;
    -> end $$
    

```

## 1.4 调用存储过程

```sql
call sp_update_sex(908,'ccc')$$
```

## 1.5 删除存储过程

```sql
 drop procedure if exists sp_update_sex $$
```

## 1.6 存储过程体

使用 declare 语句声明局部变量

```sql
declare cid int;
```

- 只能再存储过程体的 begin ... end 语句块中声明
- 必须再存储过程的开头处声明
- 作用范围仅限去声明的它的 begin ... end 语句块
- 不同于用户变量

局部变量和用户变量的区别

- 局部变量声明时，在其前面没有@ 符号，并且它只能被声明它的 begin ... end 语句块中的语句所使用。（而且只能再begin...end最开始的位置声明）
- 用户变量在声明时，会在其名称前面使用 @ 符号，同时已声明的用户变量存在于整个会话中。

使用set 语句 为局部变量赋值

```sql
set cid = 910;	
```

使用 select ... into 语句把选定列的值直接存储到局部变量中

```sql
select col_name[,...] into var_name[,...] table_expr;
```

- col_name   指定列名
- var_name  指定要赋值的变量名
- table_expr  表示 select 语句中的  from 子句及后面的语法部分

## 1.7流程控制语句

### 1.7.1 条件判断语句

- if ... then ... else 语句

```sql
if 条件 then
	表达式1
else
	表达式2
end if;
```

- case 语句

```sql
case when 条件
	then 表达式1
	else 表达式2
end
```

### 1.7.2 循环语句

- while 语句

- repeat 语句

- loop 语句

- iterater语句（跳出循环）

## 1.8 游标

使用 declare cursor 语句创建游标(声明游标)

```sql
declare cursor_name cursor for select_statement;
```

使用open语句打开游标

```sql
open cursor_name;
```

使用 fetch ... into 语句读取数据

```sql
fetch cursor_name into var_name[,var_name]...
```

使用close 关闭游标

```sql
close cursor;
```



# 2 存储函数

## 2.1 什么是存储函数

存储函数和存储过程是一样，是由SQL语句和过程式语句组成的代码片段。

调用存储函数和调用系统内置函数的方法一样

## 2.2 创建存储函数

```sql
create function sp_name([func_parameter[,...]])
	returns type
	routine_body
```

- renturns type 用于声明存储函数返回值的数据类型，type指定返回值的数据类型
- routine_body 是存储函数体

存储函数不能有输出参数

```sql
mysql> use mysql_test;
    -> delimiter $$
    -> create function func_name(cid int)
    -> returns char(20)
    -> deterministic   -- 确定性函数 提高where的性能
    -> begin
    -> declare csex char(20);
    -> select sex into csex from cust where cust_id = cid;
    -> if sex is null 
    -> then
    ->  	return(select'没有该客户');
    -> else 
    ->		if sex = 'M' 
    ->  	then
    -> 			return(select'女');
    -> 		else 
    ->			return(select '男');
    -> 		end if;
    -> end if;
    -> end$$
```

存储函数和存储过程的区别

| 存储函数                             | 存储过程             |
| ------------------------------------ | -------------------- |
| 不能有输出参数                       | 可以有输出参数       |
| 必须要有一条return语句               | 不允许包含return语句 |
| 可以直接调用存储函数，不需要call语句 | 需要call语句调用     |

## 2.3 调用存储函数

```sql
select func_search(908)$$
```

简答题：如何调用存储函数

select 函数名(参数...);

## 2.4 删除存储函数

```sql
drop function if exists func_name;
```

